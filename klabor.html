<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–ª–∞–±–æ—Ä ‚Äî –î–µ–±–µ—Ä—Ü –û–Ω–ª–∞–π–Ω</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --felt: #1a4a2e;
    --felt-dark: #122e1c;
    --felt-light: #235c38;
    --gold: #c9a84c;
    --gold-light: #f0d080;
    --card-bg: #fdf6e3;
    --card-red: #c0392b;
    --card-black: #1a1a2e;
    --text: #f0e8d0;
    --bid-blue: #2c5f8a;
    --bid-active: #3a7fbf;
    --shadow: rgba(0,0,0,0.5);
    --radius: 10px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--felt-dark);
    font-family: 'Crimson Pro', Georgia, serif;
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  /* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
  #lobby {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: radial-gradient(ellipse at 50% 40%, #1e5c38 0%, #0d2b1a 70%);
    gap: 0;
  }

  .logo {
    font-family: 'Cinzel Decorative', serif;
    font-size: clamp(2.2rem, 6vw, 4rem);
    color: var(--gold);
    text-shadow: 0 0 40px rgba(201,168,76,0.4), 2px 2px 0 #7a5010;
    letter-spacing: 4px;
    margin-bottom: 6px;
    animation: fadeDown 0.8s ease;
  }
  .logo-sub {
    font-family: 'Crimson Pro', serif;
    font-style: italic;
    font-size: 1.1rem;
    color: rgba(240,216,128,0.6);
    letter-spacing: 8px;
    text-transform: uppercase;
    margin-bottom: 48px;
    animation: fadeDown 0.8s ease 0.1s both;
  }

  .lobby-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 16px;
    padding: 36px 44px;
    width: min(440px, 92vw);
    backdrop-filter: blur(12px);
    animation: fadeUp 0.8s ease 0.2s both;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .lobby-card label {
    font-size: 0.8rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: rgba(240,216,128,0.7);
    margin-bottom: 4px;
    display: block;
  }

  .input-group { display: flex; flex-direction: column; }

  input[type=text] {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(201,168,76,0.35);
    border-radius: 8px;
    padding: 12px 16px;
    color: #fff;
    font-family: 'Crimson Pro', serif;
    font-size: 1.1rem;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type=text]:focus { border-color: var(--gold); }
  input[type=text]::placeholder { color: rgba(255,255,255,0.25); }

  .select-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .sel-btn {
    flex: 1;
    min-width: 80px;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(201,168,76,0.3);
    background: rgba(0,0,0,0.25);
    color: rgba(240,216,128,0.7);
    font-family: 'Crimson Pro', serif;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .sel-btn.active {
    background: rgba(201,168,76,0.2);
    border-color: var(--gold);
    color: var(--gold-light);
  }
  .sel-btn:hover:not(.active) {
    border-color: rgba(201,168,76,0.6);
    color: var(--gold);
  }

  .divider {
    height: 1px;
    background: rgba(201,168,76,0.15);
    margin: 4px 0;
  }

  .btn-primary {
    padding: 14px 24px;
    border-radius: 10px;
    border: 1px solid var(--gold);
    background: linear-gradient(135deg, rgba(201,168,76,0.25) 0%, rgba(201,168,76,0.1) 100%);
    color: var(--gold-light);
    font-family: 'Cinzel Decorative', serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.25s;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, rgba(201,168,76,0.4) 0%, rgba(201,168,76,0.2) 100%);
    box-shadow: 0 0 24px rgba(201,168,76,0.25);
    transform: translateY(-1px);
  }
  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    padding: 14px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    color: rgba(240,216,128,0.7);
    font-family: 'Crimson Pro', serif;
    font-size: 1rem;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-secondary:hover {
    border-color: rgba(255,255,255,0.3);
    color: var(--text);
  }

  .room-code-display {
    background: rgba(0,0,0,0.4);
    border: 1px dashed rgba(201,168,76,0.4);
    border-radius: 8px;
    padding: 12px 16px;
    text-align: center;
    font-family: 'Cinzel Decorative', serif;
    font-size: 2rem;
    color: var(--gold);
    letter-spacing: 8px;
    cursor: pointer;
    position: relative;
  }
  .room-code-display:after {
    content: '–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
    display: block;
    font-family: 'Crimson Pro', serif;
    font-size: 0.7rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(201,168,76,0.4);
    margin-top: 4px;
  }

  .waiting-players {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .player-chip {
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    font-size: 0.9rem;
    color: var(--gold-light);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .player-chip .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #4caf50;
    box-shadow: 0 0 6px #4caf50;
  }

  .info-text {
    font-size: 0.85rem;
    color: rgba(240,216,128,0.5);
    text-align: center;
    letter-spacing: 1px;
  }

  /* ‚îÄ‚îÄ GAME TABLE ‚îÄ‚îÄ */
  #game {
    display: none;
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 50% 50%, #1e5c38 0%, #0d2b1a 80%);
    overflow: hidden;
  }

  /* Felt texture */
  #game::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image:
      repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 0;
  }

  /* SCORE BAR */
  #score-bar {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 52px;
    background: rgba(0,0,0,0.45);
    border-bottom: 1px solid rgba(201,168,76,0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    z-index: 100;
    backdrop-filter: blur(8px);
  }

  .score-team {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 160px;
  }
  .score-team.right { justify-content: flex-end; }

  .team-label {
    font-family: 'Cinzel Decorative', serif;
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: rgba(201,168,76,0.6);
    text-transform: uppercase;
  }
  .team-score {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.6rem;
    color: var(--gold);
    text-shadow: 0 0 20px rgba(201,168,76,0.4);
    min-width: 48px;
    text-align: center;
  }

  .score-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }
  .game-mode-label {
    font-family: 'Cinzel Decorative', serif;
    font-size: 0.65rem;
    color: var(--gold);
    letter-spacing: 3px;
  }
  .round-info {
    font-size: 0.75rem;
    color: rgba(240,216,128,0.4);
    letter-spacing: 2px;
  }

  /* TRUMP DISPLAY */
  #trump-display {
    position: absolute;
    top: 60px;
    right: 16px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 10px;
    padding: 8px 14px;
    text-align: center;
    z-index: 50;
  }
  .trump-label { font-size: 0.65rem; letter-spacing: 3px; color: rgba(201,168,76,0.5); text-transform: uppercase; }
  .trump-suit { font-size: 2rem; line-height: 1; margin-top: 2px; }

  /* ROUND SCORES */
  #round-scores {
    position: absolute;
    top: 60px;
    left: 16px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 10px;
    padding: 8px 14px;
    text-align: center;
    z-index: 50;
    min-width: 100px;
  }
  .rscore-label { font-size: 0.65rem; letter-spacing: 2px; color: rgba(201,168,76,0.5); text-transform: uppercase; }
  .rscore-row { display: flex; justify-content: space-between; gap: 12px; font-size: 1rem; color: var(--gold-light); margin-top: 4px; }

  /* PLAYER ZONES */
  .player-zone {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
  }
  .player-name-tag {
    background: rgba(0,0,0,0.5);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 0.8rem;
    letter-spacing: 1px;
    color: rgba(240,216,128,0.8);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .player-name-tag .turn-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: transparent;
    transition: all 0.3s;
  }
  .player-name-tag.my-turn .turn-dot {
    background: #ffeb3b;
    box-shadow: 0 0 8px #ffeb3b;
  }
  .player-name-tag.active-turn {
    border-color: rgba(255,235,59,0.5);
    color: #ffeb3b;
  }

  /* BOTTOM (my) zone */
  #zone-bottom {
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    flex-direction: column-reverse;
  }

  /* TOP zone */
  #zone-top {
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
  }

  /* LEFT zone */
  #zone-left {
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
  }

  /* RIGHT zone */
  #zone-right {
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
  }

  /* HAND */
  .hand {
    display: flex;
    position: relative;
  }

  /* Bottom hand - horizontal fan */
  #zone-bottom .hand {
    flex-direction: row;
    gap: -8px;
    margin-bottom: 6px;
    padding: 8px;
  }

  #zone-top .hand {
    flex-direction: row;
    margin-top: 6px;
  }

  #zone-left .hand, #zone-right .hand {
    flex-direction: column;
    gap: 4px;
  }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    width: 72px;
    height: 108px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid rgba(0,0,0,0.15);
    box-shadow: 2px 3px 8px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 4px 5px;
    cursor: default;
    position: relative;
    transition: transform 0.15s, box-shadow 0.15s;
    flex-shrink: 0;
  }

  .card.playable {
    cursor: pointer;
  }
  .card.playable:hover {
    transform: translateY(-16px) scale(1.05);
    box-shadow: 0 16px 24px rgba(0,0,0,0.5);
    z-index: 20;
  }
  .card.selected {
    transform: translateY(-20px) scale(1.08);
    box-shadow: 0 0 0 2px var(--gold), 0 16px 30px rgba(0,0,0,0.5);
    z-index: 25;
  }

  .card-face-down {
    background: linear-gradient(135deg, #1a3a5c 0%, #0d1f33 100%);
    border: 2px solid rgba(201,168,76,0.4);
  }
  .card-face-down::after {
    content: '';
    position: absolute;
    inset: 4px;
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 5px;
    background: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 4px,
      rgba(201,168,76,0.06) 4px,
      rgba(201,168,76,0.06) 8px
    );
  }

  .card-corner {
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
  }
  .card-corner.bottom {
    transform: rotate(180deg);
  }
  .card-suit-center {
    font-size: 2rem;
    line-height: 1;
    text-align: center;
    margin: auto;
  }
  .red { color: var(--card-red); }
  .black { color: var(--card-black); }

  /* horizontal small cards for opponents */
  .card.small {
    width: 52px;
    height: 78px;
  }
  .card.small .card-corner { font-size: 0.6rem; }
  .card.small .card-suit-center { font-size: 1.4rem; }

  /* ‚îÄ‚îÄ CENTER TABLE (played cards) ‚îÄ‚îÄ */
  #table-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 320px;
    height: 240px;
    border-radius: 50%;
    border: 1px solid rgba(201,168,76,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
  }

  .table-card-slot {
    position: absolute;
    transition: all 0.3s;
  }
  /* positions for played cards */
  .table-card-slot.bottom { bottom: 10px; left: 50%; transform: translateX(-50%); }
  .table-card-slot.top { top: 10px; left: 50%; transform: translateX(-50%); }
  .table-card-slot.left { left: 10px; top: 50%; transform: translateY(-50%); }
  .table-card-slot.right { right: 10px; top: 50%; transform: translateY(-50%); }

  .slot-name {
    font-size: 0.6rem;
    letter-spacing: 1px;
    text-align: center;
    color: rgba(201,168,76,0.4);
    margin-top: 4px;
    text-transform: uppercase;
  }

  /* ‚îÄ‚îÄ BID PANEL ‚îÄ‚îÄ */
  #bid-panel {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    backdrop-filter: blur(4px);
  }

  .bid-box {
    background: linear-gradient(160deg, #1a3a28 0%, #0d2018 100%);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 16px;
    padding: 36px 44px;
    min-width: 360px;
    text-align: center;
    box-shadow: 0 24px 64px rgba(0,0,0,0.6);
  }

  .bid-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.1rem;
    color: var(--gold);
    letter-spacing: 3px;
    margin-bottom: 6px;
  }
  .bid-subtitle {
    font-size: 0.85rem;
    color: rgba(240,216,128,0.4);
    letter-spacing: 2px;
    margin-bottom: 28px;
  }

  .bid-suits {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  .suit-btn {
    padding: 16px 8px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  .suit-btn .suit-icon { font-size: 2rem; }
  .suit-btn .suit-name { font-size: 0.65rem; letter-spacing: 1px; text-transform: uppercase; color: rgba(255,255,255,0.5); }
  .suit-btn:hover {
    background: rgba(201,168,76,0.15);
    border-color: var(--gold);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  .suit-btn.selected {
    background: rgba(201,168,76,0.2);
    border-color: var(--gold);
  }
  .suit-btn .suit-icon.red { color: #e74c3c; }
  .suit-btn .suit-icon.black { color: #ecf0f1; }

  .bid-pass-btn {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.04);
    color: rgba(240,216,128,0.5);
    font-family: 'Crimson Pro', serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .bid-pass-btn:hover {
    background: rgba(180,40,40,0.15);
    border-color: rgba(200,60,60,0.4);
    color: #e74c3c;
  }
  .bid-confirm-btn {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid var(--gold);
    background: linear-gradient(135deg, rgba(201,168,76,0.3), rgba(201,168,76,0.1));
    color: var(--gold-light);
    font-family: 'Cinzel Decorative', serif;
    font-size: 0.95rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.25s;
    margin-top: 10px;
  }
  .bid-confirm-btn:hover {
    background: linear-gradient(135deg, rgba(201,168,76,0.45), rgba(201,168,76,0.2));
    box-shadow: 0 0 20px rgba(201,168,76,0.2);
  }
  .bid-confirm-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .bid-who { font-size: 0.85rem; color: rgba(240,216,128,0.5); margin-bottom: 20px; letter-spacing: 1px; }

  .bid-history {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
    margin-bottom: 18px;
    min-height: 28px;
  }
  .bid-chip {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    letter-spacing: 1px;
  }
  .bid-chip.pass { background: rgba(200,60,60,0.2); color: #e07070; border: 1px solid rgba(200,60,60,0.3); }
  .bid-chip.bid { background: rgba(201,168,76,0.15); color: var(--gold); border: 1px solid rgba(201,168,76,0.3); }

  /* ‚îÄ‚îÄ MESSAGES / NOTIFICATIONS ‚îÄ‚îÄ */
  #notif {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    pointer-events: none;
  }
  .notif-msg {
    background: rgba(0,0,0,0.75);
    border: 1px solid rgba(201,168,76,0.35);
    border-radius: 20px;
    padding: 8px 20px;
    font-size: 0.9rem;
    color: var(--gold-light);
    backdrop-filter: blur(8px);
    animation: notifIn 0.3s ease, notifOut 0.4s ease 2.6s forwards;
  }
  .notif-msg.big {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.4rem;
    padding: 14px 32px;
    letter-spacing: 2px;
  }

  /* ‚îÄ‚îÄ ROUND END OVERLAY ‚îÄ‚îÄ */
  #round-end {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    align-items: center;
    justify-content: center;
    z-index: 300;
    backdrop-filter: blur(6px);
  }
  .round-end-box {
    background: linear-gradient(160deg, #1a3a28, #0d2018);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 16px;
    padding: 40px 52px;
    text-align: center;
    min-width: 360px;
    box-shadow: 0 32px 80px rgba(0,0,0,0.7);
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .round-end-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.5rem;
    color: var(--gold);
    letter-spacing: 3px;
    margin-bottom: 24px;
  }
  .round-score-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
  }
  .round-score-table th {
    font-size: 0.7rem;
    letter-spacing: 3px;
    color: rgba(201,168,76,0.5);
    text-transform: uppercase;
    padding: 6px 12px;
    border-bottom: 1px solid rgba(201,168,76,0.15);
  }
  .round-score-table td {
    padding: 8px 12px;
    font-size: 1rem;
    color: var(--text);
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .round-score-table tr.winner td { color: var(--gold); font-weight: 600; }

  /* ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ */
  #game-over {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    align-items: center;
    justify-content: center;
    z-index: 400;
    backdrop-filter: blur(10px);
  }
  .game-over-box {
    text-align: center;
    animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .trophy { font-size: 6rem; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
  .game-over-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 2.5rem;
    color: var(--gold);
    text-shadow: 0 0 40px rgba(201,168,76,0.5);
    letter-spacing: 4px;
    margin-bottom: 8px;
  }
  .game-over-sub {
    font-size: 1.1rem;
    color: rgba(240,216,128,0.5);
    letter-spacing: 3px;
    margin-bottom: 32px;
  }

  /* ‚îÄ‚îÄ DECK INDICATOR ‚îÄ‚îÄ */
  #deck-indicator {
    position: absolute;
    top: 50%;
    right: 20%;
    transform: translateY(-50%);
    z-index: 8;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  .deck-count-label { font-size: 0.65rem; letter-spacing: 2px; color: rgba(201,168,76,0.4); text-transform: uppercase; }
  .deck-count { font-size: 1.2rem; color: var(--gold); }

  /* Stacked deck visual */
  .deck-stack {
    position: relative;
    width: 52px;
    height: 78px;
    margin-bottom: 4px;
  }
  .deck-stack .card-back {
    position: absolute;
    width: 52px;
    height: 78px;
    border-radius: 6px;
    background: linear-gradient(135deg, #1a3a5c, #0d1f33);
    border: 1.5px solid rgba(201,168,76,0.3);
  }
  .deck-stack .card-back:nth-child(1) { top: 4px; left: 4px; }
  .deck-stack .card-back:nth-child(2) { top: 2px; left: 2px; }
  .deck-stack .card-back:nth-child(3) { top: 0; left: 0; }

  /* ANIMATIONS */
  @keyframes fadeDown { from { opacity:0; transform: translateY(-20px); } to { opacity:1; transform: none; } }
  @keyframes fadeUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: none; } }
  @keyframes popIn { from { opacity:0; transform: scale(0.7); } to { opacity:1; transform: scale(1); } }
  @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
  @keyframes notifIn { from { opacity:0; transform: translateY(-10px) scale(0.9); } to { opacity:1; transform: none; } }
  @keyframes notifOut { to { opacity:0; transform: translateY(-10px) scale(0.9); } }
  @keyframes dealCard {
    from { opacity:0; transform: translate(0, -200px) rotate(10deg); }
    to { opacity:1; transform: none; }
  }
  .deal-anim { animation: dealCard 0.4s ease forwards; }

  /* card overlap in hand */
  #zone-bottom .hand .card:not(:first-child) { margin-left: -20px; }
  #zone-top .hand .card:not(:first-child) { margin-left: -24px; }

  /* MESSAGES LOG */
  #msg-log {
    position: absolute;
    bottom: 200px;
    left: 16px;
    width: 200px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 50;
    pointer-events: none;
  }
  .msg-line {
    font-size: 0.75rem;
    color: rgba(240,216,128,0.4);
    letter-spacing: 0.5px;
    animation: fadeUp 0.3s ease;
  }

  /* Action button */
  #action-area {
    position: absolute;
    bottom: 165px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    display: flex;
    gap: 10px;
  }

  /* Hidden by default */
  .hidden { display: none !important; }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    .card { width: 58px; height: 87px; }
    .card .card-suit-center { font-size: 1.5rem; }
    #zone-bottom .hand .card:not(:first-child) { margin-left: -26px; }
    .bid-box { padding: 24px 20px; min-width: unset; width: 92vw; }
  }

  /* Marriages / combos banner */
  .combo-banner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    background: rgba(0,0,0,0.8);
    border: 2px solid var(--gold);
    border-radius: 14px;
    padding: 20px 40px;
    text-align: center;
    z-index: 250;
    pointer-events: none;
    animation: popIn 0.3s ease, notifOut 0.4s ease 2.6s forwards;
  }
  .combo-banner .combo-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.3rem;
    color: var(--gold);
    margin-bottom: 4px;
  }
  .combo-banner .combo-pts {
    font-size: 2rem;
    color: #fff;
    font-weight: bold;
  }

  /* Taken tricks indicator */
  .tricks-taken {
    font-size: 0.7rem;
    letter-spacing: 1px;
    color: rgba(201,168,76,0.5);
    text-align: center;
    margin-top: 2px;
  }

  /* Combo panel ‚Äî —Å–ª–µ–≤–∞ –æ—Ç –∫–∞—Ä—Ç */
  .combo-panel {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-right: 10px;
    align-self: flex-end;
    margin-bottom: 8px;
  }
  .combo-chip {
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 8px;
    padding: 5px 10px;
    font-size: 0.75rem;
    color: var(--gold-light);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    gap: 8px;
    white-space: nowrap;
    transition: all 0.2s;
  }
  .combo-chip:hover {
    background: rgba(201,168,76,0.3);
    border-color: var(--gold);
  }
  .combo-chip.bella {
    border-color: rgba(255,100,100,0.5);
    background: rgba(255,80,80,0.1);
  }
  .combo-chip-pts {
    color: var(--gold);
    font-weight: 600;
  }

  /* –û—Ç–∫—Ä—ã—Ç–∞—è –∫–∞—Ä—Ç–∞ –∫–æ–∑—ã—Ä—å */
  #open-card-area {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 15;
    pointer-events: none;
  }
  .open-card-label {
    font-size: 0.65rem;
    letter-spacing: 3px;
    color: rgba(201,168,76,0.6);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  /* disabled suit in bid */
  .suit-btn.disabled-suit {
    opacity: 0.25 !important;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lobby">
  <div class="logo">–ö–ª–∞–±–æ—Ä</div>
  <div class="logo-sub">–î–µ–±–µ—Ä—Ü –û–Ω–ª–∞–π–Ω</div>

  <!-- MAIN MENU -->
  <div class="lobby-card" id="main-menu">
    <div class="input-group">
      <label>–í–∞—à–µ –∏–º—è</label>
      <input type="text" id="player-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è..." maxlength="16" autocomplete="off">
    </div>
    <div class="divider"></div>
    <button class="btn-primary" id="btn-show-create">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <button class="btn-secondary" id="btn-show-join">–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É</button>
  </div>

  <!-- CREATE ROOM -->
  <div class="lobby-card hidden" id="create-menu">
    <div class="input-group">
      <label>–†–µ–∂–∏–º –∏–≥—Ä—ã</label>
      <div class="select-row">
        <div class="sel-btn active" data-mode="solo">1√ó1</div>
        <div class="sel-btn" data-mode="trio">1√ó1√ó1</div>
        <div class="sel-btn" data-mode="team">2√ó2</div>
      </div>
    </div>
    <div class="input-group">
      <label>–î–æ —Å–∫–æ–ª—å–∫–∏ –æ—á–∫–æ–≤</label>
      <div class="select-row">
        <div class="sel-btn active" data-pts="501">501</div>
        <div class="sel-btn" data-pts="1001">1001</div>
      </div>
    </div>
    <div class="divider"></div>
    <button class="btn-primary" id="btn-create-room">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
    <button class="btn-secondary" id="btn-back-join">‚Üê –ù–∞–∑–∞–¥</button>
  </div>

  <!-- WAITING ROOM -->
  <div class="lobby-card hidden" id="waiting-room">
    <div style="text-align:center">
      <div class="team-label" style="font-size:0.75rem;margin-bottom:8px">–ö–û–î –ö–û–ú–ù–ê–¢–´</div>
      <div class="room-code-display" id="room-code-disp" >‚Äî‚Äî</div>
    </div>
    <div class="info-text">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏</div>
    <div class="divider"></div>
    <div class="team-label" style="text-align:center">–ò–ì–†–û–ö–ò –í –ö–û–ú–ù–ê–¢–ï</div>
    <div class="waiting-players" id="waiting-players-list"></div>
    <div class="info-text" id="waiting-info">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
    <button class="btn-primary hidden" id="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!</button>
    <button class="btn-secondary" id="btn-leave">–í—ã–π—Ç–∏</button>
  </div>

  <!-- JOIN ROOM -->
  <div class="lobby-card hidden" id="join-menu">
    <div class="input-group">
      <label>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</label>
      <input type="text" id="join-code" placeholder="XXXX" maxlength="6" autocomplete="off"
        style="text-align:center;font-family:'Cinzel Decorative',serif;font-size:1.5rem;letter-spacing:8px"
        oninput="this.value=this.value.toUpperCase()">
    </div>
    <button class="btn-primary" id="btn-join-room">–í–æ–π—Ç–∏</button>
    <button class="btn-secondary" id="btn-back-join">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game">
  <!-- Score Bar -->
  <div id="score-bar">
    <div class="score-team">
      <div>
        <div class="team-label" id="team1-label">–ö–æ–º–∞–Ω–¥–∞ 1</div>
        <div class="team-score" id="team1-score">0</div>
      </div>
    </div>
    <div class="score-center">
      <div class="game-mode-label" id="mode-label">501</div>
      <div class="round-info" id="round-label">–†–∞—É–Ω–¥ 1</div>
    </div>
    <div class="score-team right">
      <div>
        <div class="team-label" id="team2-label">–ö–æ–º–∞–Ω–¥–∞ 2</div>
        <div class="team-score" id="team2-score">0</div>
      </div>
    </div>
  </div>

  <!-- Trump Display -->
  <div id="trump-display">
    <div class="trump-label">–ö–æ–∑—ã—Ä—å</div>
    <div class="trump-suit" id="trump-suit-icon">?</div>
  </div>

  <!-- Round scores -->
  <div id="round-scores">
    <div class="rscore-label">–í —Ä–∞—É–Ω–¥–µ</div>
    <div class="rscore-row">
      <span id="rs1">0</span>
      <span>‚Äî</span>
      <span id="rs2">0</span>
    </div>
  </div>

  <!-- Deck -->
  <div id="deck-indicator">
    <div class="deck-stack">
      <div class="card-back"></div>
      <div class="card-back"></div>
      <div class="card-back"></div>
    </div>
    <div class="deck-count-label">–ö–æ–ª–æ–¥–∞</div>
    <div class="deck-count" id="deck-count">32</div>
  </div>

  <!-- Table Center -->
  <div id="table-center">
    <div class="table-card-slot bottom" id="slot-bottom"></div>
    <div class="table-card-slot top" id="slot-top"></div>
    <div class="table-card-slot left" id="slot-left"></div>
    <div class="table-card-slot right" id="slot-right"></div>
  </div>

  <!-- Player Zones -->
  <div class="player-zone" id="zone-bottom">
    <div class="hand" id="hand-bottom"></div>
    <div class="player-name-tag" id="nametag-bottom">
      <div class="turn-dot"></div>
      <span id="pname-bottom">–í—ã</span>
    </div>
    <div class="tricks-taken" id="tricks-bottom">–í–∑—è—Ç–æ–∫: 0</div>
  </div>

  <div class="player-zone" id="zone-top">
    <div class="player-name-tag" id="nametag-top">
      <div class="turn-dot"></div>
      <span id="pname-top">‚Äî</span>
    </div>
    <div class="hand" id="hand-top"></div>
    <div class="tricks-taken" id="tricks-top">–í–∑—è—Ç–æ–∫: 0</div>
  </div>

  <div class="player-zone" id="zone-left">
    <div class="player-name-tag" id="nametag-left">
      <div class="turn-dot"></div>
      <span id="pname-left">‚Äî</span>
    </div>
    <div class="hand" id="hand-left"></div>
    <div class="tricks-taken" id="tricks-left">–í–∑—è—Ç–æ–∫: 0</div>
  </div>

  <div class="player-zone" id="zone-right">
    <div class="player-name-tag" id="nametag-right">
      <div class="turn-dot"></div>
      <span id="pname-right">‚Äî</span>
    </div>
    <div class="hand" id="hand-right"></div>
    <div class="tricks-taken" id="tricks-right">–í–∑—è—Ç–æ–∫: 0</div>
  </div>

  <!-- Message log -->
  <div id="msg-log"></div>

  <!-- Action Area -->
  <div id="action-area"></div>

  <!-- Notifications -->
  <div id="notif"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERLAYS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Bid Panel -->
<div id="bid-panel" class="hidden">
  <div class="bid-box">
    <div class="bid-title">–¢–û–†–ì–ò</div>
    <div class="bid-subtitle">–≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–∑—ã—Ä—å</div>
    <div class="bid-who" id="bid-who-label">–í–∞—à —Ö–æ–¥</div>
    <div class="bid-history" id="bid-history"></div>
    <div class="bid-suits" id="bid-suits">
      <div class="suit-btn" data-suit="‚ô†">
        <div class="suit-icon black">‚ô†</div>
        <div class="suit-name">–ü–∏–∫–∏</div>
      </div>
      <div class="suit-btn" data-suit="‚ô•">
        <div class="suit-icon red">‚ô•</div>
        <div class="suit-name">–ß–µ—Ä–≤—ã</div>
      </div>
      <div class="suit-btn" data-suit="‚ô¶">
        <div class="suit-icon red">‚ô¶</div>
        <div class="suit-name">–ë—É–±–Ω—ã</div>
      </div>
      <div class="suit-btn" data-suit="‚ô£">
        <div class="suit-icon black">‚ô£</div>
        <div class="suit-name">–¢—Ä–µ—Ñ—ã</div>
      </div>
    </div>
    <button class="bid-confirm-btn" id="bid-confirm-btn" disabled id="bid-confirm-btn2">–û–±—ä—è–≤–∏—Ç—å –∫–æ–∑—ã—Ä—å</button>
    <button class="bid-pass-btn" id="bid-pass-btn">–ü–∞—Å</button>
  </div>
</div>

<!-- Round End -->
<div id="round-end">
  <div class="round-end-box">
    <div class="round-end-title" id="re-title">–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω</div>
    <table class="round-score-table">
      <tr>
        <th id="re-t1h">–ö–æ–º–∞–Ω–¥–∞ 1</th>
        <th>–í–∑—è—Ç–∫–∏</th>
        <th>–ö–æ–º–±–æ</th>
        <th>–ò—Ç–æ–≥–æ</th>
      </tr>
      <tr id="re-row1">
        <td id="re-t1n">‚Äî</td>
        <td id="re-t1t">0</td>
        <td id="re-t1c">0</td>
        <td id="re-t1s">0</td>
      </tr>
      <tr id="re-row2">
        <td id="re-t2n">‚Äî</td>
        <td id="re-t2t">0</td>
        <td id="re-t2c">0</td>
        <td id="re-t2s">0</td>
      </tr>
    </table>
    <button class="btn-primary" id="btn-next-round">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ ‚Üí</button>
  </div>
</div>

<!-- Game Over -->
<div id="game-over">
  <div class="game-over-box">
    <div class="trophy">üèÜ</div>
    <div class="game-over-title" id="go-title">–ü–æ–±–µ–¥–∞!</div>
    <div class="game-over-sub" id="go-sub">–ö–æ–º–∞–Ω–¥–∞ 1 –ø–æ–±–µ–¥–∏–ª–∞</div>
    <div style="margin-top:32px;display:flex;gap:16px;justify-content:center">
      <button class="btn-primary" id="btn-play-again">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      <button class="btn-secondary" id="btn-back-lobby">–í –º–µ–Ω—é</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE REST API ‚Äî –±–µ–∑ CDN, —á–∏—Å—Ç—ã–π fetch
//  –ó–∞–º–µ–Ω–∏ DB_URL –Ω–∞ —Å–≤–æ–π –∏–∑ Firebase Console
//  (Realtime Database ‚Üí —Å–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  –ù–ê–°–¢–†–û–ô–ö–ê ‚Äî –≤—Å—Ç–∞–≤—å —Å–≤–æ–π Firebase URL –Ω–∏–∂–µ
//  –ü—Ä–∏–º–µ—Ä: https://my-game-abc12-default-rtdb.europe-west1.firebasedatabase.io
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB_URL = 'https://klabor-card-game-default-rtdb.europe-west1.firebasedatabase.app';

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É
const DB_CONFIGURED = !DB_URL.includes('YOUR_PROJECT');
if (!DB_CONFIGURED) {
  document.addEventListener('DOMContentLoaded', () => {
    const warn = document.createElement('div');
    warn.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c0392b;color:#fff;text-align:center;padding:10px 16px;z-index:9999;font-family:monospace;font-size:13px;';
    warn.innerHTML = '‚ö†Ô∏è Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –ó–∞–º–µ–Ω–∏ DB_URL –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–≤–æ–π URL –∏–∑ Firebase Console ‚Üí Realtime Database';
    document.body.appendChild(warn);
  });
}

const db = null; // placeholder ‚Äî REST API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç db –æ–±—ä–µ–∫—Ç–∞

// –•—Ä–∞–Ω–∏–ª–∏—â–µ SSE-–ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è off()
const _sseMap = new Map();

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–∏
function normPath(path) { return path.replace(/^\//, '').replace(/\/+/g, '/'); }
function dbUrl(path) { return `${DB_URL}/${normPath(path)}.json`; }

// GET ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑
async function dbGet(path) {
  try {
    const r = await fetch(dbUrl(path));
    if (!r.ok) { console.error('dbGet error', r.status, await r.text()); return null; }
    return r.json();
  } catch(e) { console.error('dbGet fetch error:', e); return null; }
}

// SET ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å
async function dbSet(path, data) {
  try {
    const r = await fetch(dbUrl(path), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!r.ok) console.error('dbSet error', r.status, await r.text());
  } catch(e) { console.error('dbSet fetch error:', e); }
}

// UPDATE ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (PATCH)
async function dbUpdate(path, data) {
  try {
    const r = await fetch(dbUrl(path), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!r.ok) console.error('dbUpdate error', r.status, await r.text());
  } catch(e) { console.error('dbUpdate fetch error:', e); }
}

// DELETE
async function dbDelete(path) {
  try {
    await fetch(dbUrl(path), { method: 'DELETE' });
  } catch(e) { console.error('dbDelete error:', e); }
}

// LISTEN ‚Äî Server-Sent Events (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
// POLLING –≤–º–µ—Å—Ç–æ SSE ‚Äî –Ω–∞–¥—ë–∂–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ
const POLL_INTERVAL = 1500; // –º—Å –º–µ–∂–¥—É –æ–ø—Ä–æ—Å–∞–º–∏

function dbListen(path, callback) {
  let lastJson = null;
  let stopped  = false;

  async function poll() {
    if (stopped) return;
    try {
      const data = await dbGet(path);
      const json = JSON.stringify(data);
      if (json !== lastJson) {
        lastJson = json;
        callback(data);
      }
    } catch(e) { /* –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ */ }
    if (!stopped) setTimeout(poll, POLL_INTERVAL);
  }

  poll(); // —Å—Ä–∞–∑—É –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
  const handle = { stop: () => { stopped = true; } };
  _sseMap.set(path, handle);
  return handle;
}

// UNLISTEN
function dbUnlisten(path) {
  const handle = _sseMap.get(path);
  if (handle) { handle.stop(); _sseMap.delete(path); }
}

// ‚îÄ‚îÄ –°–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –æ–±—ë—Ä—Ç–∫–∏ (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ–º) ‚îÄ‚îÄ
// ref() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç-–ø—É—Ç—å
function ref(dbIgnored, path) { return { path }; }

function set(dbRef, data) { return dbSet(dbRef.path, data); }

function get(dbRef) {
  return dbGet(dbRef.path).then(data => ({
    exists: () => data !== null && data !== undefined,
    val:    () => data
  }));
}

function update(dbRef, data) {
  const basePath = typeof dbRef === 'string' ? dbRef : dbRef.path;
  // –ö–ª—é—á–∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å '/' ‚Äî —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ SET –¥–ª—è –∫–∞–∂–¥–æ–≥–æ nested –ø—É—Ç–∏
  const promises = [];
  for (const [k, v] of Object.entries(data)) {
    promises.push(dbSet(basePath + '/' + k, v));
  }
  return Promise.all(promises);
}

function remove(dbRef) { return dbDelete(dbRef.path); }

function onValue(dbRef, callback) {
  const path = typeof dbRef === 'string' ? dbRef : dbRef.path;
  const wrap = data => {
    callback({
      exists: () => data !== null && data !== undefined,
      val:    () => data
    });
  };
  // –°—Ä–∞–∑—É —á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  dbGet(path).then(wrap);
  // –ü–æ—Ç–æ–º —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
  return dbListen(path, wrap);
}

function off(dbRef, _event, _cb) {
  const path = typeof dbRef === 'string' ? dbRef : dbRef.path;
  dbUnlisten(path);
}

// roomRef = {path: 'rooms/XXXX'} ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö DB –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUITS     = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS     = ['7','8','9','10','J','Q','K','A'];
const RED_SUITS = ['‚ô•','‚ô¶'];

// Points for tricks
const TRICK_PTS = { '7':0,'8':0,'9':0,'10':10,'J':2,'Q':3,'K':4,'A':11 };
// In trump suit J=20, 9=14
const TRUMP_PTS = { '7':0,'8':0,'9':14,'10':10,'J':20,'Q':3,'K':4,'A':11 };
// Sequence combo values
const SEQ_PTS = { 3:20, 4:50, 5:100, 6:150, 7:200, 8:1000 };
// Marriage values
const MARRIAGE_PTS = { trump: 40, nonTrump: 20 };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let myId       = null; // firebase player id in room
let myName     = '';
let roomCode   = '';
let roomRef    = null;
let myHand     = []; // {suit, rank}
let gameState  = null;
let roomData   = null;
let listeners  = {};

let selectedCard = null;
let selectedBidSuit = null;

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –±—ã–ª–∞
function restoreSession() {
  const savedId   = sessionStorage.getItem('klabor_myId');
  const savedCode = sessionStorage.getItem('klabor_roomCode');
  if (savedId && savedCode) {
    myId      = savedId;
    roomCode  = savedCode;
    roomRef   = ref(db, 'rooms/' + savedCode);
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–Ω–∞—Ç–∞ –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    get(roomRef).then(snap => {
      if (snap.exists()) {
        const r = snap.val();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ
        if (r.players && r.players[myId]) {
          myName = r.players[myId].name || '–ò–≥—Ä–æ–∫';
          hide('main-menu');
          if (r.status === 'waiting') {
            show('waiting-room');
            document.getElementById('room-code-disp').textContent = savedCode;
          }
          listenRoom();
        } else {
          // –ù–∞—Å –Ω–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ ‚Äî –æ—á–∏—â–∞–µ–º
          sessionStorage.removeItem('klabor_myId');
          sessionStorage.removeItem('klabor_roomCode');
        }
      } else {
        sessionStorage.removeItem('klabor_myId');
        sessionStorage.removeItem('klabor_roomCode');
      }
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genCode(len=4) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r = '';
  for(let i=0;i<len;i++) r += chars[Math.floor(Math.random()*chars.length)];
  return r;
}

function genId() {
  return Math.random().toString(36).substr(2,9) + Date.now().toString(36);
}

function suitColor(s) { return RED_SUITS.includes(s) ? 'red' : 'black'; }

function cardPts(card, trump) {
  if (card.suit === trump) return TRUMP_PTS[card.rank] ?? 0;
  return TRICK_PTS[card.rank] ?? 0;
}

function cardPower(card, trump) {
  // Returns sortable power: trump > led suit > others
  const trumpOrder = ['7','8','Q','K','10','A','9','J']; // J highest in trump
  const normalOrder= ['7','8','9','J','Q','K','10','A'];
  if (card.suit === trump) return 100 + trumpOrder.indexOf(card.rank);
  return normalOrder.indexOf(card.rank);
}

function createDeck() {
  const deck = [];
  for (const suit of SUITS) for (const rank of RANKS) deck.push({suit,rank});
  return deck;
}

function shuffle(arr) {
  const a = [...arr];
  for(let i=a.length-1;i>0;i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOBBY UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chosenMode = 'solo';
let chosenPts  = 501;

function selectMode(el, v) {
  document.querySelectorAll('[data-mode]').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  chosenMode = v;
};

function selectPts(el, v) {
  document.querySelectorAll('[data-pts]').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  chosenPts = v;
};

// –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
async function testFirebaseConnection() {
  if (!DB_CONFIGURED) return;
  try {
    const r = await fetch(DB_URL + '/.json', { method: 'GET' });
    if (r.ok || r.status === 401) {
      console.log('‚úÖ Firebase –¥–æ—Å—Ç—É–ø–µ–Ω, —Å—Ç–∞—Ç—É—Å:', r.status);
      // –£–±–∏—Ä–∞–µ–º –±–∞–Ω–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const warn = document.getElementById('firebase-warn');
      if(warn) warn.remove();
    } else {
      console.error('‚ùå Firebase –≤–µ—Ä–Ω—É–ª:', r.status, r.statusText);
      showFirebaseError('–û—à–∏–±–∫–∞ ' + r.status + ': –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Firebase (Rules ‚Üí ".read": true)');
    }
  } catch(e) {
    console.error('‚ùå Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
    showFirebaseError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å URL –∏ –ø—Ä–∞–≤–∏–ª–∞ Firebase.');
  }
}

function showFirebaseError(msg) {
  let warn = document.getElementById('firebase-warn');
  if (!warn) {
    warn = document.createElement('div');
    warn.id = 'firebase-warn';
    warn.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c0392b;color:#fff;text-align:center;padding:10px 16px;z-index:9999;font-family:monospace;font-size:12px;';
    document.body.appendChild(warn);
  }
  warn.textContent = '‚ö†Ô∏è ' + msg;
}

function showCreateRoom() {
  myName = (document.getElementById('player-name').value || '').trim() || '–ò–≥—Ä–æ–∫';
  hide('main-menu'); show('create-menu');
}
function showJoinRoom() {
  myName = (document.getElementById('player-name').value || '').trim() || '–ò–≥—Ä–æ–∫';
  hide('main-menu'); show('join-menu');
}
function backToMain() {
  hide('create-menu'); hide('join-menu'); hide('waiting-room');
  show('main-menu');
}

async function createRoom() {
  if (!DB_CONFIGURED) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π Firebase DB_URL –≤ —Ñ–∞–π–ª–µ!'); return; }
  roomCode = genCode();
  myId     = genId();
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ sessionStorage —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
  sessionStorage.setItem('klabor_myId', myId);
  sessionStorage.setItem('klabor_roomCode', roomCode);
  roomRef  = ref(db, 'rooms/'+roomCode);
  const modeMaxPlayers = { solo:2, trio:3, team:4 };
  const data = {
    mode: chosenMode,
    target: chosenPts,
    maxPlayers: modeMaxPlayers[chosenMode],
    status: 'waiting',
    host: myId,
    players: { [myId]: { name: myName, order: 0 } },
    scores: {},
    round: 0,
    createdAt: Date.now()
  };
  try {
    await set(roomRef, data);
    hide('create-menu'); show('waiting-room');
    document.getElementById('room-code-disp').textContent = roomCode;
    listenRoom();
  } catch(e) {
    console.error('Firebase error:', e);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase: ' + e.message);
  }
}

async function joinRoom() {
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!code) return;
  myName = document.getElementById('player-name').value.trim() || '–ò–≥—Ä–æ–∫';
  const snap = await get(ref(db,'rooms/'+code));
  if (!snap.exists()) return notify('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', true);
  const r = snap.val();
  if (r.status !== 'waiting') return notify('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å', true);
  const players = r.players || {};
  if (Object.keys(players).length >= r.maxPlayers) return notify('–ö–æ–º–Ω–∞—Ç–∞ –ø–æ–ª–Ω–∞—è', true);
  myId = genId();
  roomCode = code;
  sessionStorage.setItem('klabor_myId', myId);
  sessionStorage.setItem('klabor_roomCode', roomCode);
  roomRef  = ref(db,'rooms/'+code);
  const order = Object.keys(players).length;
  await update(ref(db,`rooms/${code}/players/${myId}`), { name: myName, order });
  hide('join-menu'); show('waiting-room');
  document.getElementById('room-code-disp').textContent = code;
  listenRoom();
};

async function leaveRoom() {
  if (roomRef) {
    await remove(ref(db,`rooms/${roomCode}/players/${myId}`));
    cleanup();
  }
  backToMain();
};

function copyCode() {
  navigator.clipboard?.writeText(roomCode).catch(()=>{});
  notify('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
};

function listenRoom() {
  if (listeners.room) off(roomRef, 'value', listeners.room);
  listeners.room = onValue(roomRef, snap => {
    if (!snap.exists()) { backToMain(); return; }
    const r = snap.val();
    roomData = r;
    if (!document.getElementById('waiting-room').classList.contains('hidden')) {
      updateWaitingUI(r);
    }
    if (r.status === 'playing') {
      if (document.getElementById('game').style.display !== 'block') startGameUI(r);
      handleGameState(r);
    }
    if (r.status === 'gameOver') {
      if (document.getElementById('game').style.display !== 'block') startGameUI(r);
      handleGameState(r);
      setTimeout(() => showGameOver(r), 500);
    }
  });
}

function updateWaitingUI(r) {
  if (!r || !r.host || !r.maxPlayers) return;
  const players = Object.values(r.players||{}).sort((a,b)=>a.order-b.order);
  const list = document.getElementById('waiting-players-list');
  list.innerHTML = players.map(p =>
    `<div class="player-chip"><div class="dot"></div>${p.name}</div>`
  ).join('');
  const needed = r.maxPlayers - players.length;
  const info = document.getElementById('waiting-info');
  if (needed > 0) info.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ ${needed} –∏–≥—Ä–æ–∫${needed===1?'–∞':'–æ–≤'}...`;
  else info.textContent = '–í—Å–µ –≥–æ—Ç–æ–≤—ã!';
  const startBtn = document.getElementById('start-btn');
  const enoughPlayers = players.length >= r.maxPlayers;
  // –ö–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï–ú –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  // startGame() –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫—Ç–æ –ø–µ—Ä–≤—ã–º –Ω–∞–∂–∞–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –∏–≥—Ä—É
  if (enoughPlayers) {
    startBtn.classList.remove('hidden');
    startBtn.textContent = '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!';
    startBtn.style.opacity = '1';
    startBtn.style.pointerEvents = 'auto';
  } else {
    startBtn.classList.add('hidden');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startGame() {
  if (roomData && roomData.host !== myId) {
    notify('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É');
    return;
  }
  const players = Object.entries(roomData.players||{})
    .sort((a,b)=>a[1].order-b[1].order)
    .map(([id,p])=>({id, name:p.name}));
  const teams = buildTeams(players, roomData.mode);
  const scores = {};
  players.forEach(p => { scores[p.id] = 0; });
  const teamScores = buildTeamScores(teams);

  await update(roomRef, {
    status: 'playing',
    players: Object.fromEntries(players.map(p=>[p.id,{name:p.name,order:p.order??0}])),
    teams,
    teamScores,
    scores,
    round: 1
  });
  await dealNewRound(players, teams);
};

function buildTeams(players, mode) {
  if (mode === 'team' && players.length === 4) {
    return {
      t1: [players[0].id, players[2].id],
      t2: [players[1].id, players[3].id]
    };
  }
  // solo / trio: each player is own team
  const t = {};
  players.forEach((p,i)=>{ t['t'+(i+1)] = [p.id]; });
  return t;
}

function buildTeamScores(teams) {
  const ts = {};
  Object.keys(teams).forEach(k=>{ ts[k]=0; });
  return ts;
}

function getTeamOf(playerId, teams) {
  for (const [tk, members] of Object.entries(teams)) {
    if (members.includes(playerId)) return tk;
  }
  return null;
}

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Ä—Ç: –ø–æ –º–∞—Å—Ç–∏ –∑–∞—Ç–µ–º –ø–æ —Å—Ç–∞—Ä—à–∏–Ω—Å—Ç–≤—É
function sortHand(hand, trump) {
  const suitOrder = trump
    ? [trump, ...SUITS.filter(s=>s!==trump)]
    : SUITS;
  const rankOrder = ['7','8','9','10','J','Q','K','A'];
  const trumpRankOrder = ['7','8','Q','K','10','A','9','J'];
  return [...hand].sort((a,b) => {
    const si = suitOrder.indexOf(a.suit) - suitOrder.indexOf(b.suit);
    if (si !== 0) return si;
    const ro = a.suit === trump ? trumpRankOrder : rankOrder;
    return ro.indexOf(a.rank) - ro.indexOf(b.rank);
  });
}

async function dealNewRound(players, teams) {
  const deck = shuffle(createDeck());
  const n = players.length;

  // –†–∞–∑–¥–∞—ë–º –ø–æ 6 –∫–∞—Ä—Ç (3+3) ‚Äî –ø—Ä–∞–≤–∏–ª–æ –¥–µ–±–µ—Ä—Ü–∞
  // –ü—Ä–∏ –∏–≥—Ä–µ –≤—á–µ—Ç–≤–µ—Ä–æ–º ‚Äî –ø–æ 8 –∫–∞—Ä—Ç (–Ω–µ—Ç –ø—Ä–∏–∫—É–ø–∞ –ø–æ 3, —Å—Ä–∞–∑—É –ø–æ 8? –Ω–µ—Ç ‚Äî –ø–æ 3+3+2)
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç: 2 –∏–≥—Ä–æ–∫–∞ ‚Üí 9 –∫–∞—Ä—Ç, 3 ‚Üí 9 –∫–∞—Ä—Ç, 4 ‚Üí 8 –∫–∞—Ä—Ç
  const firstDeal = n === 4 ? 3 : 3; // –ø–µ—Ä–≤—ã–µ 3 –∫–∞—Ä—Ç—ã
  const hands = {};
  players.forEach(p => { hands[p.id] = []; });

  // –ü–µ—Ä–≤–∞—è –ø–æ—Ä—Ü–∏—è ‚Äî 3 –∫–∞—Ä—Ç—ã –∫–∞–∂–¥–æ–º—É –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ
  let deckIdx = 0;
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < 3; j++) {
      hands[players[i].id].push(deck[deckIdx++]);
    }
  }

  // –û—Ç–∫—Ä—ã—Ç–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–∑—ã—Ä—å
  const openCard = deck[deckIdx++];

  // –í—Ç–æ—Ä–∞—è –ø–æ—Ä—Ü–∏—è ‚Äî –µ—â—ë 3 –∫–∞—Ä—Ç—ã –∫–∞–∂–¥–æ–º—É
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < 3; j++) {
      hands[players[i].id].push(deck[deckIdx++]);
    }
  }

  // Determine dealer (rotate by round, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å —Å–¥–∞—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π)
  const snap = await get(roomRef);
  const r = snap.val();
  const round = r.round || 1;
  // dealerIdx –∏–∑ roomData –µ—Å–ª–∏ –µ—Å—Ç—å lastDealer, –∏–Ω–∞—á–µ –ø–æ —Ä–∞—É–Ω–¥—É
  const dealerIdx = (round - 1) % n;
  const dealer = players[dealerIdx].id;
  const firstBidder = players[(dealerIdx + 1) % n].id;

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç—ã
  players.forEach(p => {
    hands[p.id] = sortHand(hands[p.id], null);
  });

  const gs = {
    phase: 'bidding',
    bidRound: 1, // 1 = –º–∞—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–∞—Ä—Ç—ã, 2 = –ª—é–±–∞—è –º–∞—Å—Ç—å
    hands,
    dealer,
    currentPlayer: firstBidder,
    trump: null,
    openCard,        // –æ—Ç–∫—Ä—ã—Ç–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –∫–æ–∑—ã—Ä—å
    trick: {},
    trickLeader: null,
    tricksTaken: {},
    roundPoints: {},
    combos: {},
    bids: [],
    firstBidder,
    deckSize: deck.length - deckIdx
  };
  players.forEach(p=>{
    gs.tricksTaken[p.id] = 0;
    gs.roundPoints[p.id] = 0;
  });

  await update(roomRef, { gameState: gs });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME UI INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGameUI(r) {
  hide('lobby'); hide('waiting-room');
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('game').style.display = 'block';

  // Set mode label
  const modeNames = {solo:'1√ó1',trio:'1√ó1√ó1',team:'2√ó2'};
  document.getElementById('mode-label').textContent = r.target + ' –æ—á–∫–æ–≤';

  // Team labels & scores
  setupTeamLabels(r);
}

function setupTeamLabels(r) {
  const teams = r.teams||{};
  const players = r.players||{};
  if (r.mode === 'team') {
    const t1names = (teams.t1||[]).map(id=>players[id]?.name||'?').join(' + ');
    const t2names = (teams.t2||[]).map(id=>players[id]?.name||'?').join(' + ');
    document.getElementById('team1-label').textContent = t1names;
    document.getElementById('team2-label').textContent = t2names;
  } else {
    // solo: show just names
    const plist = Object.values(players).sort((a,b)=>a.order-b.order);
    document.getElementById('team1-label').textContent = plist[0]?.name||'‚Äî';
    document.getElementById('team2-label').textContent = plist[1]?.name||'‚Äî';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN GAME STATE HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleGameState(r) {
  gameState = r.gameState;
  if (!gameState) return;
  roomData = r;

  // My hand from state
  myHand = (gameState.hands?.[myId]) || [];

  // Update score display
  updateScoreDisplay(r);

  // Arrange players around table
  arrangePlayerZones(r);

  // Update all hands
  renderAllHands(r);

  // Table (played cards)
  renderTable(r);

  // Round/deck info
  document.getElementById('round-label').textContent = '–†–∞—É–Ω–¥ ' + (r.round||1);
  document.getElementById('deck-count').textContent  = gameState.deckSize || 0;

  // Trump
  if (gameState.trump) {
    document.getElementById('trump-suit-icon').textContent = gameState.trump;
    document.getElementById('trump-suit-icon').className   = 'trump-suit ' + suitColor(gameState.trump);
  } else {
    document.getElementById('trump-suit-icon').textContent = '?';
    document.getElementById('trump-suit-icon').className   = 'trump-suit';
  }

  // Round scores
  if (gameState.trump && r.teams) {
    const ts1 = getTeamPoints(r,'t1');
    const ts2 = getTeamPoints(r,'t2');
    document.getElementById('rs1').textContent = ts1;
    document.getElementById('rs2').textContent = ts2;
  }

  // Tricks taken
  Object.keys(gameState.tricksTaken||{}).forEach(pid => {
    const zone = getZoneForPlayer(pid, r);
    const el = document.getElementById('tricks-'+zone);
    if (el) el.textContent = '–í–∑—è—Ç–æ–∫: ' + (gameState.tricksTaken[pid]||0);
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–±–æ
  const declared = gameState.declaredCombos || [];
  declared.forEach(d => {
    if (d.player !== myId) {
      const pname = r.players[d.player]?.name||'?';
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî —Å–ª–µ–¥–∏–º –ø–æ ID
      const key = 'shown_'+d.player+d.name;
      if (!sessionStorage.getItem(key)) {
        sessionStorage.setItem(key, '1');
        showComboBanner(pname + ': ' + d.name, d.pts, false);
      }
    }
  });

  // Phase handling
  if (gameState.phase === 'bidding') {
    handleBidPhase(r);
  } else if (gameState.phase === 'playing') {
    document.getElementById('bid-panel').classList.add('hidden');
    handlePlayPhase(r);
  } else if (gameState.phase === 'roundEnd') {
    showRoundEnd(r);
  }
}

function getTeamPoints(r, teamKey) {
  const gs = r.gameState;
  const members = r.teams?.[teamKey]||[];
  let pts = 0;
  members.forEach(id => {
    pts += gs.roundPoints?.[id]||0;
    pts += gs.combos?.[id]||0;
  });
  return pts;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYER ZONE ARRANGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ZONES = ['bottom','top','left','right'];

function getOrderedPlayers(r) {
  return Object.entries(r.players||{})
    .sort((a,b)=>a[1].order-b[1].order)
    .map(([id,p])=>({id,name:p.name}));
}

function getZoneForPlayer(pid, r) {
  const players = getOrderedPlayers(r);
  const myIdx   = players.findIndex(p=>p.id===myId);
  const pidIdx  = players.findIndex(p=>p.id===pid);
  const n       = players.length;
  const rel     = ((pidIdx - myIdx) + n) % n;
  // rel=0: bottom, rel=1: left (or top for 2p), rel=2: top (for 3/4p), rel=3: right
  if (n === 2) return rel===0?'bottom':'top';
  if (n === 3) {
    const map=[['bottom','left','right']];
    return map[0][rel];
  }
  // 4 players
  const map4=['bottom','left','top','right'];
  return map4[rel];
}

function arrangePlayerZones(r) {
  const players = getOrderedPlayers(r);
  const n = players.length;

  // Hide all zones first
  ['top','left','right'].forEach(z=>{
    document.getElementById('zone-'+z).style.display='none';
  });

  players.forEach(p => {
    const zone = getZoneForPlayer(p.id, r);
    const zEl  = document.getElementById('zone-'+zone);
    zEl.style.display = 'flex';
    document.getElementById('pname-'+zone).textContent = p.name + (p.id===myId?' (–í—ã)':'');
  });

  // Highlight current player
  const cp = gameState.currentPlayer;
  const cpZone = cp ? getZoneForPlayer(cp, r) : null;
  ZONES.forEach(z => {
    const nt = document.getElementById('nametag-'+z);
    if (!nt) return;
    nt.classList.remove('active-turn','my-turn');
    if (z === cpZone) {
      nt.classList.add('active-turn');
      if (cp === myId) nt.classList.add('my-turn');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER HANDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAllHands(r) {
  const players = getOrderedPlayers(r);
  players.forEach(p => {
    const zone = getZoneForPlayer(p.id, r);
    const handEl = document.getElementById('hand-'+zone);
    if (!handEl) return;
    handEl.innerHTML = '';

    if (p.id === myId) {
      // –ö–æ–º–±–æ-–ø–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞ –æ—Ç –∫–∞—Ä—Ç
      const combo = gameState.combos?.[myId];
      if (combo && combo.items && combo.items.length > 0) {
        const comboPanel = document.createElement('div');
        comboPanel.className = 'combo-panel';
        combo.items.forEach(item => {
          const chip = document.createElement('div');
          chip.className = 'combo-chip' + (item.isBella ? ' bella' : '');
          chip.title = '–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–ø–µ—Ä–Ω–∏–∫—É';
          chip.innerHTML = `<span>${item.name}</span><span class="combo-chip-pts">+${item.pts}</span>`;
          chip.addEventListener('click', () => declareCombo(item));
          comboPanel.appendChild(chip);
        });
        handEl.parentElement.insertBefore(comboPanel, handEl);
      }

      // Show my cards face-up
      const playable = canIPlay(r);
      myHand.forEach((card, i) => {
        const el = makeCardEl(card, true);
        el.style.animationDelay = (i*0.04)+'s';
        if (playable) {
          if (isCardPlayable(card, r)) {
            el.classList.add('playable');
            el.addEventListener('click', ()=>onCardClick(card, el));
          } else {
            el.style.opacity = '0.4';
          }
        }
        handEl.appendChild(el);
      });
    } else {
      // Face-down cards
      const hand = gameState.hands?.[p.id]||[];
      const count = hand.length;
      for (let i=0;i<count;i++) {
        const el = makeCardBack(zone==='left'||zone==='right');
        handEl.appendChild(el);
      }
    }
  });
}

function makeCardEl(card, faceUp) {
  const el = document.createElement('div');
  el.className = 'card deal-anim';
  if (!faceUp) {
    el.classList.add('card-face-down');
    return el;
  }
  const color = suitColor(card.suit);
  el.innerHTML = `
    <div class="card-corner ${color}">
      <span>${card.rank}</span>
      <span>${card.suit}</span>
    </div>
    <div class="card-suit-center ${color}">${card.suit}</div>
    <div class="card-corner bottom ${color}">
      <span>${card.rank}</span>
      <span>${card.suit}</span>
    </div>
  `;
  el.dataset.suit = card.suit;
  el.dataset.rank = card.rank;
  return el;
}

function makeCardBack(small=false) {
  const el = document.createElement('div');
  el.className = 'card card-face-down' + (small?' small':'');
  return el;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER TABLE (played cards + open card)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable(r) {
  const gs = r.gameState || gameState;
  const trick = gs.trick || {};
  ['bottom','top','left','right'].forEach(zone => {
    const slot = document.getElementById('slot-'+zone);
    if(slot) slot.innerHTML = '';
  });
  const players = getOrderedPlayers(r);
  Object.entries(trick).forEach(([pid, card]) => {
    const zone = getZoneForPlayer(pid, r);
    const slot = document.getElementById('slot-'+zone);
    if (!slot) return;
    const el = makeCardEl(card, true);
    el.style.width = '64px'; el.style.height = '96px';
    slot.appendChild(el);
    const pname = players.find(p=>p.id===pid)?.name||'';
    const nm = document.createElement('div');
    nm.className='slot-name';
    nm.textContent = pname;
    slot.appendChild(nm);
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—É—é –∫–∞—Ä—Ç—É (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–∑—ã—Ä—å) –≤–æ –≤—Ä–µ–º—è —Ç–æ—Ä–≥–æ–≤
  let openArea = document.getElementById('open-card-area');
  if (gs.phase === 'bidding' && gs.openCard) {
    if (!openArea) {
      openArea = document.createElement('div');
      openArea.id = 'open-card-area';
      openArea.innerHTML = '<div class="open-card-label">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –∫–æ–∑—ã—Ä—å</div>';
      document.getElementById('table-center').appendChild(openArea);
    }
    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldCard = openArea.querySelector('.card');
    if (oldCard) oldCard.remove();
    const cardEl = makeCardEl(gs.openCard, true);
    cardEl.style.margin = '0 auto';
    openArea.appendChild(cardEl);
    openArea.style.display = 'block';
  } else if (openArea) {
    openArea.style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BIDDING ‚Äî –¥–≤—É—Ö–∫—Ä—É–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleBidPhase(r) {
  const gs = r.gameState;
  const isMyTurn = gs.currentPlayer === myId;
  const bp = document.getElementById('bid-panel');
  bp.classList.remove('hidden');

  const openCard = gs.openCard;
  const bidRound = gs.bidRound || 1;
  const isObligatory = gs.obligatory; // –æ–±—è–∑ ‚Äî –¥–∏–ª–µ—Ä –æ–±—è–∑–∞–Ω –≤—ã–±—Ä–∞—Ç—å

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  document.getElementById('bid-title').textContent = bidRound === 1 ? '–¢–û–†–ì–ò' : '–í–¢–û–†–û–ô –ö–†–£–ì';
  document.getElementById('bid-subtitle').textContent = bidRound === 1
    ? `–û—Ç–∫—Ä—ã—Ç–∞—è –∫–∞—Ä—Ç–∞: ${openCard ? openCard.rank + ' ' + openCard.suit : '?'}`
    : '–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±—É—é –º–∞—Å—Ç—å –∫–æ–∑—ã—Ä–µ–º';

  // –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫
  const histEl = document.getElementById('bid-history');
  histEl.innerHTML = (gs.bids||[]).map(b=>{
    const pname = r.players[b.player]?.name||'?';
    if (b.type==='pass') return `<div class="bid-chip pass">${pname}: –ü–∞—Å</div>`;
    return `<div class="bid-chip bid">${pname}: ${b.suit}</div>`;
  }).join('');

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–∞—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–∞—Ä—Ç—ã –≤ –ø–µ—Ä–≤–æ–º –∫—Ä—É–≥–µ
  document.querySelectorAll('.suit-btn').forEach(btn => {
    btn.classList.remove('disabled-suit');
    btn.style.opacity = '1';
    if (bidRound === 1 && openCard && btn.dataset.suit !== openCard.suit) {
      btn.style.opacity = '0.3';
      btn.classList.add('disabled-suit');
    }
  });

  const whoEl = document.getElementById('bid-who-label');
  if (isMyTurn) {
    const obligMsg = isObligatory ? ' (–û–ë–Ø–ó ‚Äî –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å!)' : '';
    whoEl.textContent = '–í–∞—à —Ö–æ–¥' + obligMsg;
    document.getElementById('bid-suits').style.opacity='1';
    document.getElementById('bid-suits').style.pointerEvents='auto';
    document.getElementById('bid-confirm-btn').disabled = !selectedBidSuit;
    // –ü–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –æ–±—è–∑–µ
    document.getElementById('bid-pass-btn').style.display = isObligatory ? 'none' : 'block';
  } else {
    const cpname = r.players[gs.currentPlayer]?.name||'?';
    whoEl.textContent = cpname + ' –¥—É–º–∞–µ—Ç...';
    document.getElementById('bid-suits').style.opacity='0.3';
    document.getElementById('bid-suits').style.pointerEvents='none';
    document.getElementById('bid-confirm-btn').disabled = true;
    document.getElementById('bid-pass-btn').style.display='none';
  }
}

function selectBidSuit(el) {
  if (el.classList.contains('disabled-suit')) return;
  document.querySelectorAll('.suit-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  selectedBidSuit = el.dataset.suit;
  document.getElementById('bid-confirm-btn').disabled = false;
}

async function confirmBid() {
  if (!selectedBidSuit || gameState.currentPlayer !== myId) return;
  const players = getOrderedPlayers(roomData);
  const bids = [...(gameState.bids||[]), { player:myId, type:'trump', suit:selectedBidSuit }];

  // –ö–æ–∑—ã—Ä—å –≤—ã–±—Ä–∞–Ω ‚Äî —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç—ã —Å —É—á—ë—Ç–æ–º –∫–æ–∑—ã—Ä—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏–≥—Ä–µ
  const sortedHands = {};
  Object.entries(gameState.hands||{}).forEach(([pid, hand]) => {
    sortedHands[pid] = sortHand(hand, selectedBidSuit);
  });

  // –°—á–∏—Ç–∞–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
  const combos = calcAllCombos(sortedHands, selectedBidSuit);

  const gs = {
    ...gameState,
    trump: selectedBidSuit,
    phase: 'playing',
    hands: sortedHands,
    currentPlayer: gameState.firstBidder,
    trickLeader: gameState.firstBidder,
    bids,
    trick: {},
    combos,
    bidWinner: myId  // –∫—Ç–æ –Ω–∞–∑–Ω–∞—á–∏–ª –∫–æ–∑—ã—Ä—å
  };

  selectedBidSuit = null;
  document.querySelectorAll('.suit-btn').forEach(b=>b.classList.remove('selected'));
  await update(roomRef, { gameState: gs });
  setTimeout(()=>announceCombos(combos, roomData), 500);
}

async function passBid() {
  if (gameState.currentPlayer !== myId) return;
  const players = getOrderedPlayers(roomData);
  const n = players.length;
  const myIdx = players.findIndex(p=>p.id===myId);
  const nextIdx = (myIdx+1)%n;
  const gs = gameState;
  const bidRound = gs.bidRound || 1;

  const bids = [...(gs.bids||[]), { player:myId, type:'pass' }];

  // –ü–∞—Å—ã –≤ —Ç–µ–∫—É—â–µ–º –∫—Ä—É–≥–µ
  const passesThisRound = bids.filter(b=>b.type==='pass').length;

  if (bidRound === 1) {
    // –ü–µ—Ä–≤—ã–π –∫—Ä—É–≥: –º–∞—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–∞—Ä—Ç—ã
    if (passesThisRound >= n) {
      // –í—Å–µ —Å–ø–∞—Å–æ–≤–∞–ª–∏ –≤ 1–º –∫—Ä—É–≥–µ ‚Üí –≤—Ç–æ—Ä–æ–π –∫—Ä—É–≥, –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç–æ—Ç –∂–µ firstBidder
      await update(roomRef, {
        'gameState/bids': bids,
        'gameState/bidRound': 2,
        'gameState/currentPlayer': gs.firstBidder
      });
    } else {
      await update(roomRef, {
        'gameState/bids': bids,
        'gameState/currentPlayer': players[nextIdx].id
      });
    }
  } else {
    // –í—Ç–æ—Ä–æ–π –∫—Ä—É–≥: –ª—é–±–∞—è –º–∞—Å—Ç—å
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –¥–æ—à–ª–∏ –ª–∏ –¥–æ –¥–∏–ª–µ—Ä–∞ (–æ–±—è–∑)
    const passesInRound2 = bids.filter((b,i) => {
      // –°—á–∏—Ç–∞–µ–º –ø–∞—Å—ã –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –≤—Ç–æ—Ä–æ–≥–æ –∫—Ä—É–≥–∞
      const round1passes = gs.bids.filter(b=>b.type==='pass').length;
      return i >= round1passes && b.type==='pass';
    }).length;

    if (players[nextIdx].id === gs.dealer || passesInRound2 >= n) {
      // –°–ª–µ–¥—É—é—â–∏–π ‚Äî –¥–∏–ª–µ—Ä ‚Üí –æ–±—è–∑
      await update(roomRef, {
        'gameState/bids': bids,
        'gameState/currentPlayer': gs.dealer,
        'gameState/obligatory': true
      });
    } else if (passesInRound2 >= n - 1) {
      // –í—Å–µ —Å–ø–∞—Å–æ–≤–∞–ª–∏ –≤–æ –≤—Ç–æ—Ä–æ–º –∫—Ä—É–≥–µ ‚Üí –æ–±—è–∑ –¥–ª—è –¥–∏–ª–µ—Ä–∞
      await update(roomRef, {
        'gameState/bids': bids,
        'gameState/currentPlayer': gs.dealer,
        'gameState/obligatory': true
      });
    } else {
      await update(roomRef, {
        'gameState/bids': bids,
        'gameState/currentPlayer': players[nextIdx].id
      });
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMBOS ‚Äî —Ç–µ—Ä—Ü/–∫–≤–∞—Ä—Ç/–∫–≤–∏–Ω—Ç + –±–µ–ª–ª–∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RANK_ORDER = ['7','8','9','10','J','Q','K','A'];

function calcAllCombos(hands, trump) {
  const combos = {};
  Object.entries(hands||{}).forEach(([pid, hand]) => {
    combos[pid] = calcCombosDetail(hand, trump);
  });
  return combos;
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç: { total, items: [{name, pts, cards}] }
function calcCombosDetail(hand, trump) {
  const items = [];
  let total = 0;

  // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–µ—Ä—Ü=3, –∫–≤–∞—Ä—Ç=4, –∫–≤–∏–Ω—Ç=5...)
  SUITS.forEach(suit => {
    const inSuit = hand.filter(c=>c.suit===suit);
    const indices = inSuit.map(c=>RANK_ORDER.indexOf(c.rank)).sort((a,b)=>a-b);
    // –ù–∞–π—Ç–∏ –≤—Å–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    let start = 0;
    while (start < indices.length) {
      let len = 1;
      while (start+len < indices.length && indices[start+len] === indices[start+len-1]+1) len++;
      if (len >= 3) {
        const pts = SEQ_PTS[len] || (len >= 5 ? 100 + (len-5)*50 : 0);
        const seqCards = inSuit.filter(c => {
          const idx = RANK_ORDER.indexOf(c.rank);
          return idx >= indices[start] && idx <= indices[start+len-1];
        });
        const names = {3:'–¢–µ—Ä—Ü',4:'–ö–≤–∞—Ä—Ç',5:'–ö–≤–∏–Ω—Ç',6:'–°–µ–∫—Å—Ç',7:'–°–µ–ø—Ç',8:'–í—Å–µ –∫–∞—Ä—Ç—ã!'};
        items.push({ name: names[len]||`${len} –ø–æ–¥—Ä—è–¥`, pts, cards: seqCards, suit });
        total += pts;
      }
      start += len;
    }
  });

  // –ë–µ–ª–ª–∞ = –ö + –î –∫–æ–∑—ã—Ä—è (20 –æ—á–∫–æ–≤ –ø—Ä–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ + 20 –∑–∞ –≤–∑—è—Ç–∫—É –∫–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç—Å—è –≤—Ç–æ—Ä–∞—è)
  const hasKingTrump  = hand.some(c=>c.suit===trump&&c.rank==='K');
  const hasQueenTrump = hand.some(c=>c.suit===trump&&c.rank==='Q');
  if (hasKingTrump && hasQueenTrump) {
    items.push({ name:'–ë–µ–ª–ª–∞ (–ö+–î –∫–æ–∑—ã—Ä—è)', pts: MARRIAGE_PTS.trump, cards:[], suit:trump, isBella:true });
    total += MARRIAGE_PTS.trump;
  }

  // –ú–∞—Ä—å—è–∂ –Ω–µ–∫–æ–∑—ã—Ä–Ω—ã–π –ö+–î
  SUITS.filter(s=>s!==trump).forEach(suit => {
    const hasK = hand.some(c=>c.suit===suit&&c.rank==='K');
    const hasQ = hand.some(c=>c.suit===suit&&c.rank==='Q');
    if (hasK && hasQ) {
      items.push({ name:`–ú–∞—Ä—å—è–∂ ${suit}`, pts: MARRIAGE_PTS.nonTrump, cards:[], suit, isBella:false });
      total += MARRIAGE_PTS.nonTrump;
    }
  });

  return { total, items };
}

// –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
function calcCombos(hand, trump) {
  return calcCombosDetail(hand, trump).total;
}

function announceCombos(combos, r) {
  Object.entries(combos).forEach(([pid, combo]) => {
    const pts = typeof combo === 'object' ? combo.total : combo;
    if (pts > 0) {
      const pname = r.players[pid]?.name||'?';
      const isMine = pid===myId;
      const details = typeof combo === 'object'
        ? combo.items.map(i=>i.name+' +'+i.pts).join(', ')
        : '';
      showComboBanner(pname + (isMine?' (–í—ã)':''), pts, isMine, details);
    }
  });
}

// –û–±—ä—è–≤–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Å–æ–ø–µ—Ä–Ω–∏–∫—É
async function declareCombo(item) {
  if (!gameState || gameState.phase !== 'playing') return;
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –∫–æ–º–±–æ –≤ Firebase —á—Ç–æ–±—ã –≤—Å–µ —É–≤–∏–¥–µ–ª–∏
  const declared = gameState.declaredCombos || [];
  declared.push({ player: myId, name: item.name, pts: item.pts, suit: item.suit });
  await update(roomRef, { 'gameState/declaredCombos': declared });
  notify(`–í—ã –æ–±—ä—è–≤–∏–ª–∏: ${item.name} (+${item.pts})`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function canIPlay(r) {
  return r.gameState?.phase==='playing' && r.gameState?.currentPlayer===myId;
}

function isCardPlayable(card, r) {
  const gs = r.gameState;
  const trick = gs.trick||{};
  const led   = Object.values(trick)[0];
  if (!led) return true; // First to play ‚Äî anything

  const ledSuit = led.suit;
  const trump   = gs.trump;

  // Must follow suit if possible
  const hasSuit = myHand.some(c=>c.suit===ledSuit);
  if(hasSuit) return card.suit===ledSuit;

  // Must trump if possible and led was not trump
  if(ledSuit!==trump) {
    const hasTrump = myHand.some(c=>c.suit===trump);
    if(hasTrump) return card.suit===trump;
  }

  return true; // Can play anything
}

function onCardClick(card, el) {
  if (!canIPlay(roomData)) return;
  if (!isCardPlayable(card, roomData)) return;

  if (selectedCard && selectedCard.suit===card.suit && selectedCard.rank===card.rank) {
    // Double-click = play
    playCard(card);
  } else {
    // First click = select
    document.querySelectorAll('.card.selected').forEach(c=>c.classList.remove('selected'));
    el.classList.add('selected');
    selectedCard = card;
  }
}

async function playCard(card) {
  if (!card) return;
  const gs = gameState;
  const players = getOrderedPlayers(roomData);
  const n = players.length;
  const myIdx = players.findIndex(p=>p.id===myId);

  const trick = { ...(gs.trick||{}), [myId]: card };

  // Remove card from hand
  const newHand = myHand.filter(c=>!(c.suit===card.suit&&c.rank===card.rank));

  const updates = {};
  updates[`gameState/trick/${myId}`] = card;
  updates[`gameState/hands/${myId}`] = newHand;

  // Check if trick complete
  if (Object.keys(trick).length === n) {
    // Determine winner
    const winner = determineTrickWinner(trick, gs.trump);
    // Calc trick points
    const pts = Object.values(trick).reduce((s,c)=>s+cardPts(c,gs.trump),0);
    const curPts = gs.roundPoints?.[winner]||0;
    const newTricks = (gs.tricksTaken?.[winner]||0)+1;

    updates[`gameState/roundPoints/${winner}`] = curPts + pts;
    updates[`gameState/tricksTaken/${winner}`] = newTricks;
    updates['gameState/trick'] = {};
    updates['gameState/trickLeader'] = winner;
    updates['gameState/currentPlayer'] = winner; // winner leads next

    // Check if all hands empty => round end
    const allEmpty = Object.values(gs.hands).every((h,i)=>{
      const pid = players[i]?.id;
      if (!pid) return true;
      if (pid===myId) return newHand.length===0;
      return (h||[]).length===0;
    });

    if (allEmpty) {
      // Add last trick bonus (10 pts) to winner
      updates[`gameState/roundPoints/${winner}`] = curPts + pts + 10;
      updates['gameState/phase'] = 'roundEnd';
    }
  } else {
    // Next player's turn
    const nextIdx = (myIdx+1)%n;
    updates['gameState/currentPlayer'] = players[nextIdx].id;
  }

  selectedCard = null;
  await update(roomRef, updates);
}

function determineTrickWinner(trick, trump) {
  let best = null, bestPow = -1;
  const entries = Object.entries(trick);
  const ledSuit = entries[0][1].suit;
  entries.forEach(([pid,card])=>{
    let pow = 0;
    if(card.suit===trump) pow = 100 + cardPower(card,trump);
    else if(card.suit===ledSuit) pow = cardPower(card,trump);
    else pow = -1;
    if(pow>bestPow) { bestPow=pow; best=pid; }
  });
  return best;
}

let _lastNotifiedTurn = null;
function handlePlayPhase(r) {
  const isMyTurn = r.gameState?.currentPlayer===myId;
  if (isMyTurn && _lastNotifiedTurn !== r.gameState?.currentPlayer + (r.gameState?.trick ? Object.keys(r.gameState.trick).length : 0)) {
    _lastNotifiedTurn = r.gameState?.currentPlayer + (r.gameState?.trick ? Object.keys(r.gameState.trick).length : 0);
    notify('–í–∞—à —Ö–æ–¥!');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ROUND END
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showRoundEnd(r) {
  const gs = r.gameState;
  const teams = r.teams||{};
  const mode = r.mode;

  // Calc team totals for round
  const teamPts = {};
  Object.entries(teams).forEach(([tk, members])=>{
    let pts = members.reduce((s,id)=>{
      const combo = gs.combos?.[id];
      const comboPts = typeof combo === 'object' ? (combo.total||0) : (combo||0);
      return s + (gs.roundPoints?.[id]||0) + comboPts;
    },0);
    teamPts[tk] = pts;
  });

  // Check if bidder fulfilled
  const bidderId = gs.firstBidder; // simplification
  const bidderTeam = getTeamOf(bidderId, teams);

  // Update total scores
  const scoreUpdates = {};
  const newTeamScores = { ...(r.teamScores||{}) };
  Object.entries(teamPts).forEach(([tk,pts])=>{
    newTeamScores[tk] = (newTeamScores[tk]||0) + pts;
    scoreUpdates['teamScores/'+tk] = newTeamScores[tk];
  });

  // Build round end UI
  const t1key = Object.keys(teams)[0];
  const t2key = Object.keys(teams)[1];
  const t1members = teams[t1key]||[];
  const t2members = teams[t2key]||[];
  const t1name = t1members.map(id=>r.players[id]?.name||'?').join(' & ');
  const t2name = t2members.map(id=>r.players[id]?.name||'?').join(' & ');

  const t1tricks = t1members.reduce((s,id)=>s+(gs.roundPoints?.[id]||0),0);
  const t2tricks = t2members.reduce((s,id)=>s+(gs.roundPoints?.[id]||0),0);
  const t1combos = t1members.reduce((s,id)=>{
    const c=gs.combos?.[id]; return s+(typeof c==='object'?c.total||0:c||0);
  },0);
  const t2combos = t2members.reduce((s,id)=>{
    const c=gs.combos?.[id]; return s+(typeof c==='object'?c.total||0:c||0);
  },0);

  document.getElementById('re-t1n').textContent = t1name;
  document.getElementById('re-t2n').textContent = t2name;
  document.getElementById('re-t1t').textContent = t1tricks;
  document.getElementById('re-t2t').textContent = t2tricks;
  document.getElementById('re-t1c').textContent = t1combos;
  document.getElementById('re-t2c').textContent = t2combos;
  document.getElementById('re-t1s').textContent = t1tricks+t1combos;
  document.getElementById('re-t2s').textContent = t2tricks+t2combos;

  const winner = teamPts[t1key]>teamPts[t2key]?t1name:t2name;
  document.getElementById('re-title').textContent = `${winner} –±–µ—Ä—ë—Ç —Ä–∞—É–Ω–¥!`;

  // Winner row highlighting
  if(teamPts[t1key]>teamPts[t2key]) {
    document.getElementById('re-row1').classList.add('winner');
    document.getElementById('re-row2').classList.remove('winner');
  } else {
    document.getElementById('re-row2').classList.add('winner');
    document.getElementById('re-row1').classList.remove('winner');
  }

  document.getElementById('round-end').style.display='flex';

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∫–∏ (–ø–µ—Ä–≤—ã–π –∫—Ç–æ –∑–∞–ø–∏—à–µ—Ç ‚Äî –ø–æ–±–µ–¥–∏—Ç –≥–æ–Ω–∫—É, Firebase –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω)
  if (!_scoreUpdateLock) {
    _scoreUpdateLock = true;
    setTimeout(() => { _scoreUpdateLock = false; }, 5000);
    update(roomRef, scoreUpdates);
    const target = r.target||501;
    const winnerEntry = Object.entries(newTeamScores).find(([,s])=>s>=target);
    if (winnerEntry) {
      setTimeout(()=>triggerGameOver(winnerEntry[0], r, newTeamScores), 2000);
    }
  }
}

async function triggerGameOver(winTeam, r, teamScores) {
  await update(roomRef, { status:'gameOver', winnerTeam:winTeam });
}

async function nextRound() {
  document.getElementById('round-end').style.display='none';
  // –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ‚Äî –∫—Ç–æ –ø–µ—Ä–≤—ã–π –Ω–∞–∂–∞–ª
  if (_nextRoundLock) return;
  _nextRoundLock = true;
  setTimeout(() => { _nextRoundLock = false; }, 3000);

  const newRound = (roomData.round||1)+1;
  await update(roomRef, { round:newRound });
  const players = getOrderedPlayers(roomData);
  await dealNewRound(players, roomData.teams);
}
let _nextRoundLock = false;
let _scoreUpdateLock = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCORE DISPLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateScoreDisplay(r) {
  const ts = r.teamScores||{};
  const teams = r.teams||{};
  const tkeys = Object.keys(teams);
  document.getElementById('team1-score').textContent = ts[tkeys[0]]||0;
  document.getElementById('team2-score').textContent = ts[tkeys[1]]||0;

  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏ —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–∞–º–∏ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å—Ç–æ–ª–µ
  if (!r.gameState) return;
  const players = getOrderedPlayers(r);
  players.forEach(p => {
    const zone = getZoneForPlayer(p.id, r);
    const tricksEl = document.getElementById('tricks-'+zone);
    if (!tricksEl) return;
    const taken = r.gameState.tricksTaken?.[p.id]||0;
    const roundPts = r.gameState.roundPoints?.[p.id]||0;
    const combo = r.gameState.combos?.[p.id];
    const comboPts = combo ? (typeof combo==='object' ? combo.total||0 : combo) : 0;
    tricksEl.innerHTML = `–í–∑—è—Ç–æ–∫: ${taken} &nbsp;|&nbsp; –û—á–∫–æ–≤: ${roundPts}${comboPts?'+'+comboPts:''}`;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME OVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showGameOver(r) {
  if (document.getElementById('game-over').style.display === 'flex') return;
  const wt = r.winnerTeam;
  const teams = r.teams||{};
  const members = teams[wt]||[];
  const wname = members.map(id=>r.players[id]?.name||'?').join(' & ');
  const isWinner = members.includes(myId);

  document.getElementById('go-title').textContent = isWinner ? 'üèÜ –ü–æ–±–µ–¥–∞!' : 'üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
  document.getElementById('go-sub').textContent = wname + (isWinner ? ' ‚Äî –≤—ã –ø–æ–±–µ–¥–∏–ª–∏!' : ' –ø–æ–±–µ–¥–∏–ª–∏');

  // –ò—Ç–æ–≥–æ–≤—ã–µ –æ—á–∫–∏
  const ts = r.teamScores||{};
  const tkeys = Object.keys(teams);
  const scoreHtml = tkeys.map(tk=>{
    const mnames = (teams[tk]||[]).map(id=>r.players[id]?.name||'?').join(' & ');
    return `<div style="display:flex;justify-content:space-between;gap:32px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
      <span>${mnames}</span><span style="color:var(--gold);font-weight:bold">${ts[tk]||0}</span>
    </div>`;
  }).join('');

  // –í—Å—Ç–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –≤ game-over –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  let scoresDiv = document.getElementById('go-scores');
  if (!scoresDiv) {
    scoresDiv = document.createElement('div');
    scoresDiv.id = 'go-scores';
    scoresDiv.style.cssText = 'width:100%;max-width:320px;margin:16px auto;font-size:1rem;color:var(--text)';
    document.querySelector('.game-over-box .game-over-sub').after(scoresDiv);
  }
  scoresDiv.innerHTML = scoreHtml;

  document.getElementById('game-over').style.display='flex';
}

async function playAgain() {
  document.getElementById('game-over').style.display='none';
  if (_playAgainLock) return;
  _playAgainLock = true;
  setTimeout(() => { _playAgainLock = false; }, 3000);
  const players = getOrderedPlayers(roomData);
  const teams = buildTeams(players, roomData.mode);
  await update(roomRef, {
    status:'playing', teams,
    teamScores: buildTeamScores(teams),
    round:1
  });
  await dealNewRound(players, teams);
}
let _playAgainLock = false;

function backToLobby() {
  cleanup();
  location.reload();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function notify(msg, isError=false, big=false) {
  const el = document.createElement('div');
  el.className = 'notif-msg' + (big?' big':'');
  el.textContent = msg;
  if(isError) el.style.color='#e74c3c';
  const c = document.getElementById('notif');
  c.appendChild(el);
  setTimeout(()=>el.remove(), 3200);
}

function showComboBanner(text, pts, isMine, details='') {
  const el = document.createElement('div');
  el.className = 'combo-banner';
  el.innerHTML = `
    <div class="combo-title">${isMine?'üéâ ':''}${text}</div>
    <div class="combo-pts">+${pts} –æ—á–∫–æ–≤</div>
    ${details ? `<div style="font-size:0.8rem;color:rgba(255,255,255,0.6);margin-top:4px">${details}</div>` : ''}
  `;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}

function addLog(msg) {
  const el = document.getElementById('msg-log');
  const line = document.createElement('div');
  line.className='msg-line';
  line.textContent = msg;
  el.appendChild(line);
  while(el.children.length>6) el.removeChild(el.firstChild);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }

function cleanup() {
  if (roomRef && listeners.room) {
    off(roomRef, 'value', listeners.room);
    listeners.room = null;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  if(e.key==='Enter' && selectedCard) playCard(selectedCard);
});

// Double-click on card plays it immediately
document.addEventListener('dblclick', e => {
  const card = e.target.closest('.card.playable');
  if (!card) return;
  const suit = card.dataset.suit;
  const rank = card.dataset.rank;
  if (!suit||!rank) return;
  const c = {suit,rank};
  if(isCardPlayable(c, roomData)) playCard(c);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT LISTENERS ‚Äî –Ω–∞–¥—ë–∂–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
  testFirebaseConnection();
  restoreSession();
  const on = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('click', fn); };

  on('btn-show-create',  () => showCreateRoom());
  on('btn-show-join',    () => showJoinRoom());
  on('btn-create-room',  () => createRoom());
  on('btn-back-create',  () => backToMain());
  on('btn-back-join',    () => backToMain());
  on('btn-leave',        () => leaveRoom());
  on('btn-join-room',    () => joinRoom());
  on('start-btn',        () => startGame());
  on('room-code-disp',   () => copyCode());
  on('bid-confirm-btn',  () => confirmBid());
  on('bid-confirm-btn2', () => confirmBid());
  on('bid-pass-btn',     () => passBid());
  on('btn-next-round',   () => nextRound());
  on('btn-play-again',   () => playAgain());
  on('btn-back-lobby',   () => backToLobby());

  // Delegation for sel-btn (mode/pts) and suit-btn
  document.addEventListener('click', e => {
    const modeBtn = e.target.closest('[data-mode]');
    if (modeBtn) { selectMode(modeBtn, modeBtn.dataset.mode); return; }
    const ptsBtn = e.target.closest('[data-pts]');
    if (ptsBtn) { selectPts(ptsBtn, parseInt(ptsBtn.dataset.pts)); return; }
    const suitBtn = e.target.closest('.suit-btn[data-suit]');
    if (suitBtn) { selectBidSuit(suitBtn); return; }
  });

  document.getElementById('player-name')?.addEventListener('keydown', e => {
    if(e.key==='Enter') showCreateRoom();
  });
  document.getElementById('join-code')?.addEventListener('keydown', e => {
    if(e.key==='Enter') joinRoom();
  });
}

// –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É + –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ DOM –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', bindEvents);
} else {
  bindEvents();
}

console.log('Klabor loaded!');
</script>
</body>
</html>
